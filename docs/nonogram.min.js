(function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports,require("url"),require("path"),require("fs"),require("vm"),require("worker_threads")):"function"==typeof define&&define.amd?define(["exports","url","path","fs","vm","worker_threads"],b):(a="undefined"==typeof globalThis?a||self:globalThis,b(a.nonogram={},a.url,a.path,a.fs,a.VM,a.threads))})(this,function(a,b,c,d,e,f){"use strict";function g(a,b){return a.length===b.length&&a.every((a,c)=>a===b[c])}function h(a){this.type=a,this.timeStamp=Date.now(),this.target=this.currentTarget=this.data=null}function i(){class a extends q{constructor(a,c){super();const{name:d,type:e}=c||{};a+="";let g=/^data:/.test(a)?a:b.fileURLToPath(new b.URL(a,s));const i=new f.Worker(b.fileURLToPath("undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:l&&"SCRIPT"===l.tagName.toUpperCase()&&l.src||new URL("nonogram.js",document.baseURI).href),{workerData:{mod:g,name:d,type:e}});Object.defineProperty(this,o,{value:i}),i.on("message",a=>{const b=new h("message");b.data=a,this.dispatchEvent(b)}),i.on("error",a=>{a.type="error",this.dispatchEvent(a)}),i.on("exit",()=>{this.dispatchEvent(new h("close"))})}postMessage(a,b){this[o].postMessage(a,b)}terminate(){this[o].terminate()}}return a.prototype.onmessage=a.prototype.onerror=a.prototype.onclose=null,a}function j(a,b){const{data:c}=k(a);return e.runInThisContext(c,{filename:"worker.<"+(b||"data:")+">"})}function k(a){let[b,c,d,e]=a.match(/^data: *([^;,]*)(?: *; *([^,]*))? *,(.*)$/)||[];if(!b)throw Error("Invalid Data URL.");if(e=decodeURIComponent(e),d)switch(d.toLowerCase()){case"base64":e=Buffer.from(e,"base64").toString();break;default:throw Error("Unknown Data URL encoding \""+d+"\"");}return{type:c,data:e}}var l="undefined"==typeof document?null:document.currentScript;const m={EMPTY:0,FILLED:1,UNSET:2};class n{constructor(){this.listeners=[],this.m=0,this.n=0,this.grid=[],this.hints={row:[],column:[]}}initListeners(){this.listeners=[]}removeNonPositiveHints(){function a(a,b,c){c[b]=a.filter(a=>0<a)}this.hints.row.forEach(a),this.hints.column.forEach(a)}static getSingleLine(a,b,c){const d=a.length,e=a.length?a[0].length:0,f=[];if("row"===b)for(let b=0;b<e;b+=1)f[b]=a[c][b];else if("column"===b)for(let b=0;b<d;b+=1)f[b]=a[b][c];return f}static calculateHints(a,b,c,d=!0){const e=[],f=n.getSingleLine(a,b,c);return f.reduce((a,b)=>{if(b===m.FILLED)e.push(a?e.pop()+1:1);else if(d&&b!==m.EMPTY)throw new Error;return b===m.FILLED},!1),e}isLineCorrect(a,b){try{return g(n.calculateHints(this.grid,a,b,!1),this.hints[a][b])}catch(a){return!1}}}const o=Symbol.for("worker"),p=Symbol.for("events");class q{constructor(){Object.defineProperty(this,p,{value:new Map})}dispatchEvent(a){if(a.target=a.currentTarget=this,this["on"+a.type])try{this["on"+a.type](a)}catch(a){console.error(a)}const b=this[p].get(a.type);null==b||b.forEach(b=>{try{b.call(this,a)}catch(a){console.error(a)}})}addEventListener(a,b){let c=this[p].get(a);c||this[p].set(a,c=[]),c.push(b)}removeEventListener(a,b){let c=this[p].get(a);if(c){const a=c.indexOf(b);-1!==a&&c.splice(a,1)}}}var r="function"==typeof Worker?Worker:f.isMainThread?i():function(){function a(){const a=o;o=null,a.forEach(a=>{n.dispatchEvent(a)})}if("function"==typeof global.WorkerGlobalScope)return;let{mod:g,name:l,type:m}=f.workerData;if(!g)return i();const n=global.self=global;let o=[];f.parentPort.on("message",a=>{const b=new h("message");b.data=a,null==o?n.dispatchEvent(b):o.push(b)}),f.parentPort.on("error",a=>{a.type="Error",n.dispatchEvent(a)});class p extends q{postMessage(a,b){f.parentPort.postMessage(a,b)}close(){process.exit()}importScripts(){for(let a=0;a<arguments.length;a++){const f=arguments[a];let h;h=/^data:/.test(f)?k(f).data:d.readFileSync(new b.URL(c.posix.normalize(f),b.pathToFileURL(g)),"utf-8"),e.runInThisContext(h,{filename:f})}}}let r=Object.getPrototypeOf(global);delete r.constructor,Object.defineProperties(p.prototype,r),r=Object.setPrototypeOf(global,new p),["postMessage","addEventListener","removeEventListener","dispatchEvent"].forEach(a=>{r[a]=r[a].bind(global)}),global.name=l,global.WorkerGlobalScope=p;const s=/^data:/.test(g);if("module"===m)import(s?g:b.pathToFileURL(g)).catch(a=>s&&"Not supported"===a.message?(console.warn("Worker(): Importing data: URLs requires Node 12.10+. Falling back to classic worker."),j(g,l)):void console.error(a)).then(a);else{try{/^data:/.test(g)?j(g,l):global.importScripts(g)}catch(a){console.error(a)}Promise.resolve().then(a)}}();const s=b.pathToFileURL(process.cwd()+"/");a.Solver=class extends n{constructor(a,b,{delay:c=50,onSuccess:d=()=>{},onError:e=()=>{}}={}){super(),this.worker=new r(new URL("./worker.ts","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:l&&"SCRIPT"===l.tagName.toUpperCase()&&l.src||new URL("nonogram.js",document.baseURI).href)),this.isBusy=!1,this.isError=!1,this.delay=c,this.handleSuccess=d,this.handleError=e,this.hints={row:a.slice(),column:b.slice()},this.removeNonPositiveHints(),this.m=this.hints.row.length,this.n=this.hints.column.length,this.grid=Array(this.m);for(let f=0;f<this.m;f+=1)this.grid[f]=Array(this.n).fill(m.UNSET)}initListeners(){}refresh(){this.grid=Array(this.m);for(let a=0;a<this.m;a+=1)this.grid[a]=Array(this.n).fill(m.UNSET);this.hints.row.forEach(a=>{a.isCorrect=!1,a.unchanged=!1}),this.hints.column.forEach(a=>{a.isCorrect=!1,a.unchanged=!1}),this.solve()}solve(){if(this.isBusy)return;this.isBusy=!0;const a=Date.now();this.worker.onmessage=({data:b})=>{if(this.scanner=b.scanner,this.grid=b.grid,this.hints=b.hints,"update"!==b.type)if(this.isBusy=!1,"error"===b.type){this.isError=!0;const{direction:a,i:b}=this.scanner;this.handleError(new Error(`Bad hints at ${a} ${b+1}`))}else if("finish"===b.type){this.isError=!1;const c=this.grid.every(a=>a.every(a=>a!==m.UNSET));this.handleSuccess(Date.now()-a,b.iterations,c)}},this.worker.postMessage({delay:this.delay,grid:this.grid,hints:this.hints})}}});